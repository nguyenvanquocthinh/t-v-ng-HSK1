<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chinese TTS Player</title>
    <script src="https://unpkg.com/pinyin-pro"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        padding: 20px;
        background: #f9f9f9;
      }
      .controls {
        margin: 15px 0;
      }
      button {
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        background: #4caf50;
        color: white;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #45a049;
      }
      .text-box {
        margin-top: 20px;
        background: white;
        padding: 15px;
        border-radius: 10px;
        max-width: 400px;
        margin: auto;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .word {
        cursor: pointer;
        padding: 2px 4px;
        border-radius: 4px;
      }
      .word:hover {
        background: #e6f7ff;
      }
      .tooltip {
        margin-top: 10px;
        font-size: 14px;
        color: #333;
        background: #f0f0f0;
        padding: 8px;
        border-radius: 6px;
        display: none;
      }

      .form-box {
        margin-top: 30px;
        padding: 15px;
        background: #fff;
        border-radius: 10px;
        max-width: 400px;
        margin: auto;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      input {
        width: 100%;
        padding: 8px;
        margin: 5px 0;
        border: 1px solid #ccc;
        border-radius: 6px;
      }

      .lesson-list {
        margin-top: 30px;
        text-align: left;
        max-width: 500px;
        margin: auto;
      }
      .lesson-item {
        background: #fff;
        margin: 5px 0;
        padding: 8px;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .lesson-text {
        cursor: pointer;
        flex: 1;
      }
      .delete-btn {
        background: red;
        color: white;
        border: none;
        padding: 5px 8px;
        border-radius: 4px;
        cursor: pointer;
      }
      .delete-btn:hover {
        background: darkred;
      }
    </style>
  </head>
  <body>
    <h2>üéß Luy·ªán nghe ti·∫øng Trung (TTS)</h2>

    <div class="controls">
      <button onclick="prevSentence()">‚èÆ Tr∆∞·ªõc</button>
      <button onclick="togglePlay()">‚ñ∂Ô∏è / ‚è∏</button>
      <button onclick="nextSentence()">‚è≠ Ti·∫øp</button>
    </div>

    <div class="text-box" id="lessonText"></div>
    <div class="tooltip" id="tooltip"></div>

    <!-- Form th√™m c√¢u m·ªõi -->
    <div class="form-box">
      <h3>‚ûï Th√™m c√¢u m·ªõi</h3>
      <input
        type="text"
        id="chineseInput"
        placeholder="C√¢u ti·∫øng Trung (vd: ‰Ω†Â•Ω)"
      />
      <input
        type="text"
        id="vietnameseInput"
        placeholder="Nghƒ©a ti·∫øng Vi·ªát (vd: Xin ch√†o)"
      />
      <button onclick="addLesson()">Th√™m c√¢u</button>
    </div>

    <!-- Danh s√°ch c√¢u -->
    <div class="lesson-list">
      <h3>üìö Danh s√°ch c√¢u ƒë√£ l∆∞u</h3>
      <div id="lessonItems"></div>
    </div>

    <script>
      let lessons = JSON.parse(localStorage.getItem("lessons_tts")) || [
        {
          chinese: "‰Ω†Âè´‰ªÄ‰πàÂêçÂ≠óÔºü",
          pinyin: "N«ê ji√†o sh√©nme m√≠ngz√¨?",
          vietnamese: "B·∫°n t√™n l√† g√¨?",
        },
        {
          chinese: "‰Ω†ÊòéÂ§©ÂéªÂ≠¶Ê†°ÂêóÔºü",
          pinyin: "N«ê m√≠ngtiƒÅn q√π xu√©xi√†o ma?",
          vietnamese: "Ng√†y mai b·∫°n ƒëi h·ªçc kh√¥ng?",
        },
      ];

      // üìò Dictionary (∆∞u ti√™n c·ª•m t·ª´ d√†i tr∆∞·ªõc)
      const dictionary = {
        ‰Ω†: "b·∫°n",
        Âè´: "g·ªçi, t√™n l√†",
        ‰ªÄ‰πà: "c√°i g√¨",
        ÂêçÂ≠ó: "t√™n",
        ÊòéÂ§©: "ng√†y mai",
        Âéª: "ƒëi",
        Â≠¶Ê†°: "tr∆∞·ªùng h·ªçc",
        Âêó: "t·ª´ nghi v·∫•n",
      };

      let currentIndex = 0;
      let isPlaying = false;
      let synth = window.speechSynthesis;

      const lessonText = document.getElementById("lessonText");
      const tooltip = document.getElementById("tooltip");
      const lessonItems = document.getElementById("lessonItems");

      // H√†m t√°ch c√¢u theo t·ª´ trong dictionary
      function segmentSentence(sentence) {
        let words = [];
        let i = 0;
        while (i < sentence.length) {
          let found = false;
          // th·ª≠ t√¨m c·ª•m d√†i nh·∫•t trong dictionary
          for (let len = 3; len > 0; len--) {
            let part = sentence.substr(i, len);
            if (dictionary[part]) {
              words.push(part);
              i += len;
              found = true;
              break;
            }
          }
          if (!found) {
            words.push(sentence[i]); // k√Ω t·ª± l·∫ª ch∆∞a c√≥ trong dict
            i++;
          }
        }
        return words;
      }

      function renderText(index) {
        const lesson = lessons[index];
        let words = segmentSentence(lesson.chinese);

        let chineseWords = words
          .map((w) => {
            if (w.trim() === "") return "";
            return `<span class="word" onclick="showWord('${w}')">${w}</span>`;
          })
          .join(" ");

        lessonText.innerHTML = `
        <b>‰∏≠Êñá:</b> ${chineseWords}<br>
        <b>Pinyin:</b> ${lesson.pinyin}<br>
        <b>Ti·∫øng Vi·ªát:</b> ${lesson.vietnamese}
      `;
        tooltip.style.display = "none";
      }

      function speakSentence(text) {
        if (synth.speaking) synth.cancel();
        let utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = "zh-CN";
        utterance.rate = 1;
        utterance.onend = () => {
          isPlaying = false;
        };
        synth.speak(utterance);
        isPlaying = true;
      }

      function showWord(word) {
        if (synth.speaking) synth.cancel();
        let utterance = new SpeechSynthesisUtterance(word);
        utterance.lang = "zh-CN";
        synth.speak(utterance);

        let meaning = dictionary[word] || "Ch∆∞a c√≥ nghƒ©a";
        tooltip.innerHTML = `<b>${word}</b>: ${meaning}`;
        tooltip.style.display = "block";
      }

      function togglePlay() {
        if (isPlaying) {
          synth.cancel();
          isPlaying = false;
        } else {
          speakSentence(lessons[currentIndex].chinese);
        }
      }

      function nextSentence() {
        currentIndex = (currentIndex + 1) % lessons.length;
        renderText(currentIndex);
      }

      function prevSentence() {
        currentIndex = (currentIndex - 1 + lessons.length) % lessons.length;
        renderText(currentIndex);
      }

      function addLesson() {
        const chinese = document.getElementById("chineseInput").value.trim();
        const vietnamese = document
          .getElementById("vietnameseInput")
          .value.trim();
        if (!chinese || !vietnamese) {
          alert("‚ùå Vui l√≤ng nh·∫≠p c·∫£ c√¢u ti·∫øng Trung v√† nghƒ©a ti·∫øng Vi·ªát!");
          return;
        }

        const pinyin = window.pinyinPro.pinyin(chinese, { toneType: "tone" });

        lessons.push({ chinese, pinyin, vietnamese });
        localStorage.setItem("lessons_tts", JSON.stringify(lessons));
        renderLessonList();
        alert("‚úÖ ƒê√£ th√™m c√¢u m·ªõi!");
        document.getElementById("chineseInput").value = "";
        document.getElementById("vietnameseInput").value = "";
      }

      function renderLessonList() {
        lessonItems.innerHTML = "";
        lessons.forEach((lesson, index) => {
          const div = document.createElement("div");
          div.className = "lesson-item";
          div.innerHTML = `
          <span class="lesson-text" onclick="selectLesson(${index})">${lesson.chinese} (${lesson.vietnamese})</span>
          <button class="delete-btn" onclick="deleteLesson(${index})">‚ùå</button>
        `;
          lessonItems.appendChild(div);
        });
      }

      function selectLesson(index) {
        currentIndex = index;
        renderText(currentIndex);
      }

      function deleteLesson(index) {
        if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c√¢u n√†y kh√¥ng?")) {
          lessons.splice(index, 1);
          localStorage.setItem("lessons_tts", JSON.stringify(lessons));
          renderLessonList();
          if (lessons.length > 0) {
            currentIndex = 0;
            renderText(currentIndex);
          } else {
            lessonText.innerHTML = "üì≠ Danh s√°ch tr·ªëng. H√£y th√™m c√¢u m·ªõi!";
          }
        }
      }

      // Load l·∫ßn ƒë·∫ßu
      renderLessonList();
      if (lessons.length > 0) {
        renderText(currentIndex);
      }
    </script>
  </body>
</html>
